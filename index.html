<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>GPX Hiker - Puszcza WkrzaÅ„ska</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --bg:#0f172a; --panel:#020617; --text:#e5e7eb; --accent:#22c55e;
}
.light {
  --bg:#f8fafc; --panel:#e5e7eb; --text:#020617; --accent:#16a34a;
}
body {
  margin:0; height:100vh; display:grid;
  grid-template-columns:320px 1fr;
  background:var(--bg); color:var(--text);
  font-family:system-ui,sans-serif;
}
aside {
  background:var(--panel); padding:12px;
  display:flex; flex-direction:column; gap:8px;
  overflow:auto;
}
button {
  border:none; padding:8px; border-radius:8px;
  background:var(--accent); font-weight:600; cursor:pointer;
}
small {opacity:.85}
#map {height:100%}
canvas {
  height:120px; width:100%;
  background:#0003; border-radius:8px;
}
hr {border:0;border-top:1px solid #ffffff22}
</style>
</head>

<body>

<aside>
  <h3>ğŸŒ² GPX Hiker<br>Puszcza WkrzaÅ„ska</h3>

  <button onclick="toggleTheme()">ğŸŒ™ / â˜€ï¸ Motyw</button>
  <button onclick="exportGPX()">â¬‡ï¸ Eksport GPX</button>
  <input type="file" accept=".gpx" onchange="importGPX(event)">
  <button onclick="enablePOI()">ğŸ“ Dodaj waypoint</button>
  <button onclick="clearAll()">ğŸ—‘ï¸ WyczyÅ›Ä‡ trasÄ™</button>

  <hr>

  <label><input type="checkbox" checked onchange="toggleHiking(this)"> ğŸ¥¾ Szlaki piesze</label>
  <label><input type="checkbox" checked onchange="togglePOI(this)"> ğŸ›– POI leÅ›ne</label>

  <hr>

  <small id="stats">Dystans: 0 km</small>
  <small id="time">Czas: 0 h</small>
  <canvas id="elevation"></canvas>

  <small>
    Klikaj mapÄ™ â€“ dodajesz punkty<br>
    PrzeciÄ…gaj â€“ edycja<br>
    Profil wysokoÅ›ci: opcjonalny
  </small>
</aside>

<div id="map"></div>

<script>
/* ================= MAPA ================= */
const map = L.map('map').setView([53.52, 14.55], 12);

let dark = true;
const tiles = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
  light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
};
tiles.dark.addTo(map);

/* ================= TRASA ================= */
let points = [];
let markers = [];
let pois = [];
let polyline = L.polyline([], {color:'#22c55e', weight:4}).addTo(map);
let poiMode = false;

/* ================= SZLAKI + POI ================= */
let hikingLayer = L.geoJSON(null, {
  style: {color:'#facc15', weight:2, dashArray:'4'}
}).addTo(map);

let poiLayer = L.layerGroup().addTo(map);

/* ================= EVENTY ================= */
map.on('click', e => {
  if (poiMode) {
    addPOI(e.latlng);
    poiMode = false;
    return;
  }
  addPoint(e.latlng);
});

/* ================= FUNKCJE ================= */
function addPoint(latlng) {
  const m = L.marker(latlng, {draggable:true}).addTo(map);
  m.on('drag', updateRoute);
  markers.push(m);
  updateRoute();
}

function updateRoute() {
  points = markers.map(m => m.getLatLng());
  polyline.setLatLngs(points);
  updateDistanceAndTime();
  loadElevationSafe();
}

function updateDistanceAndTime() {
  let d = 0;
  for (let i=1;i<points.length;i++)
    d += points[i-1].distanceTo(points[i]);

  const km = d/1000;
  document.getElementById('stats').innerText =
    `Dystans: ${km.toFixed(2)} km`;

  // Naismith: 5 km/h + 600 m przewyÅ¼szenia (upraszczamy)
  const hours = km / 5;
  document.getElementById('time').innerText =
    `Czas: ${hours.toFixed(1)} h`;
}

function addPOI(latlng) {
  const name = prompt("Nazwa waypointu:");
  if (!name) return;
  const m = L.marker(latlng).addTo(map)
    .bindPopup("ğŸ“ "+name);
  pois.push({latlng,name});
}

/* ================= GPX ================= */
function exportGPX() {
  if (points.length<2) return alert("Za maÅ‚o punktÃ³w");

  const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="GPX Hiker"
xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>Puszcza WkrzaÅ„ska</name><trkseg>
${points.map(p=>`<trkpt lat="${p.lat}" lon="${p.lng}"></trkpt>`).join('\n')}
</trkseg></trk>
${pois.map(p=>`<wpt lat="${p.latlng.lat}" lon="${p.latlng.lng}">
<name>${p.name}</name></wpt>`).join('\n')}
</gpx>`;

  download(gpx);
}

function importGPX(e) {
  const r = new FileReader();
  r.onload = () => {
    clearAll();
    const xml = new DOMParser().parseFromString(r.result,"text/xml");
    xml.querySelectorAll("trkpt").forEach(p =>
      addPoint(L.latLng(p.getAttribute("lat"),p.getAttribute("lon")))
    );
  };
  r.readAsText(e.target.files[0]);
}

function download(text) {
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([text],{type:"application/gpx+xml"}));
  a.download="trasa.gpx"; a.click();
}

/* ================= ELEVATION (SAFE) ================= */
async function loadElevationSafe() {
  if (points.length<2) return;
  try {
    const coords = points.map(p=>`${p.lat},${p.lng}`).join("|");
    const r = await fetch(
      `https://api.opentopodata.org/v1/srtm90m?locations=${coords}`
    );
    if (!r.ok) throw "";
    const d = await r.json();
    drawElevation(d.results.map(x=>x.elevation||0));
  } catch {
    // brak profilu = brak crasha
  }
}

function drawElevation(arr) {
  const c=document.getElementById("elevation");
  const ctx=c.getContext("2d");
  c.width=c.offsetWidth; c.height=c.offsetHeight;
  ctx.clearRect(0,0,c.width,c.height);
  const max=Math.max(...arr), min=Math.min(...arr);
  ctx.beginPath();
  arr.forEach((v,i)=>{
    const x=i/(arr.length-1)*c.width;
    const y=c.height-(v-min)/(max-min+1)*c.height;
    ctx.lineTo(x,y);
  });
  ctx.strokeStyle="#22c55e"; ctx.lineWidth=2; ctx.stroke();
}

/* ================= OVERPASS OSM ================= */
fetch(`https://overpass-api.de/api/interpreter?data=
[out:json];
(
  way["route"="hiking"](53.4,14.3,53.6,14.8);
  node["amenity"="shelter"](53.4,14.3,53.6,14.8);
  node["amenity"="parking"](53.4,14.3,53.6,14.8);
);
out geom;`)
.then(r=>r.json())
.then(data=>{
  data.elements.forEach(e=>{
    if (e.type==="way") {
      hikingLayer.addData({
        type:"Feature",
        geometry:{type:"LineString",
        coordinates:e.geometry.map(g=>[g.lon,g.lat])}
      });
    }
    if (e.type==="node") {
      L.circleMarker([e.lat,e.lon],{
        radius:4,color:"#38bdf8"
      }).bindPopup("POI").addTo(poiLayer);
    }
  });
});

/* ================= UI ================= */
function clearAll() {
  markers.forEach(m=>map.removeLayer(m));
  polyline.setLatLngs([]);
  markers=[]; points=[]; pois=[];
}

function enablePOI() {
  poiMode=true;
  alert("Kliknij mapÄ™, aby dodaÄ‡ waypoint");
}

function toggleTheme() {
  dark=!dark;
  document.body.classList.toggle("light",!dark);
  map.eachLayer(l=>map.removeLayer(l));
  (dark?tiles.dark:tiles.light).addTo(map);
  polyline.addTo(map); hikingLayer.addTo(map); poiLayer.addTo(map);
}

function toggleHiking(c){ c.checked?map.addLayer(hikingLayer):map.removeLayer(hikingLayer); }
function togglePOI(c){ c.checked?map.addLayer(poiLayer):map.removeLayer(poiLayer); }
</script>

</body>
</html>
